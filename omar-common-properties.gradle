import com.bmuschko.gradle.docker.tasks.image.Dockerfile
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage
import com.bmuschko.gradle.docker.tasks.image.DockerTagImage
import com.bmuschko.gradle.docker.tasks.image.DockerPushImage
import com.bmuschko.gradle.docker.tasks.image.DockerRemoveImage

buildscript {
    ext {
        grailsVersion = project.grailsVersion
    }
    repositories {
      jcenter()
      maven {
        url "https://plugins.gradle.org/m2/"
      }
    }
    dependencies {
        classpath 'com.bmuschko:gradle-docker-plugin:3.0.6'
        classpath 'com.github.skhatri:gradle-s3-plugin:1.0.4'
        classpath "org.jfrog.buildinfo:build-info-extractor-gradle:latest.release"
   }
}

apply plugin: com.bmuschko.gradle.docker.DockerRemoteApiPlugin
apply plugin: com.github.skhatri.s3aws.plugin.S3Plugin
apply plugin: org.jfrog.gradle.plugin.artifactory.ArtifactoryPlugin

ext {
  buildVersionTag="SNAPSHOT" // SNAPSHOT or RELEASE
  artifactoryContextUrl="https://artifacts.radiantbluecloud.com/artifactory"
  ossimMavenProxy="${artifactoryContextUrl}/ossim-deps"
  artifactoryUser="${System.env.ARTIFACTORY_USER}"
  artifactoryPassword="${System.env.ARTIFACTORY_PASSWORD}"
  jarArtifactsChanging="${buildVersionTag}"=="SNAPSHOT"?true:false
  dockerRegistryUrl="docker-registry-default.ossim.io"
  registryProjectName="o2"
  baseImage="o2-base"
  openShiftUrl="https://openshift-master.ossim.io:8443"
  dockerAppTag=(buildVersionTag=="SNAPSHOT"?"latest":"release")
  openShiftUserName="${System.env.OPENSHIFT_USERNAME}"
  openShiftPassword="${System.env.OPENSHIFT_PASSWORD}"
}

version "${buildVersion}-${buildVersionTag}"

def dockerNamespaceUrl = "${dockerRegistryUrl}/${registryProjectName}/"
def baseImageTgz = "${baseImage}.tgz"
def image = "${project.name}:${dockerAppTag}"
def imageTgz = "${project.name}.tgz"

task logIn (dependsOn: 'assemble') {
  doLast {
    exec {
      commandLine 'oc', 'login', '--insecure-skip-tls-verify', openShiftUrl,
       '-u', openShiftUserName,
       '-p', openShiftPassword
    }
    def loginTokenStream = new ByteArrayOutputStream()
    exec {
      commandLine 'oc', 'whoami', '-t'
      standardOutput loginTokenStream
    }
    def loginToken = new String(loginTokenStream.toByteArray(), 'UTF-8')?.trim()
    println loginToken
    exec {
     commandLine 'docker', 'login', '-p', loginToken, '-u', 'unused', dockerRegistryUrl
    }
  }
}

task downloadBaseImage(type: com.github.skhatri.s3aws.plugin.S3DownloadTask, dependsOn: logIn) {
  bucket = 'o2-delivery/dev/docker'
  key = baseImageTgz
  saveTo = "build/libs/${baseImageTgz}"
}

task loadBaseDockerImage(dependsOn: downloadBaseImage) {
  doLast {
    exec {
      commandLine 'docker', 'load', '-i', "build/libs/${baseImageTgz}"
    }
  }
}

task createDockerfile(type: Dockerfile, dependsOn: loadBaseDockerImage) {
    destFile = project.file('build/libs/Dockerfile')
    from baseImage
    maintainer "DigitalGlobe-RadiantBlue"
    runCommand 'useradd omar'
    copyFile "${project.name}-${version}.jar", "/home/omar"
    user 'omar'
    workingDir '/home/omar'
    exposePort 8080
    defaultCommand 'java', '-server', '-Xms256m', '-Xmx1024m', '-Djava.awt.headless=true', '-XX:+CMSClassUnloadingEnabled', '-XX:+UseGCOverheadLimit', '-Djava.security.egd=file:/dev/./urandom', '-jar', "/home/omar/${project.name}-${version}.jar"
}

task buildDockerImage(type: DockerBuildImage, dependsOn: createDockerfile) {
    inputDir = createDockerfile.destFile.parentFile
    tag = "${image}"
}

task tagDockerImage(type: DockerTagImage, dependsOn: buildDockerImage) {
  imageId "${image}"
  tag "${dockerAppTag}"
  repository  "${dockerNamespaceUrl}${project.name}"
}

task pushDockerImage(type: DockerPushImage, dependsOn: tagDockerImage) {
  imageName "${dockerNamespaceUrl}${image}"
}

task saveDockerImage(dependsOn: pushDockerImage) {
  doLast {
    exec {
      commandLine 'docker', 'save', image, '-o', "build/libs/${project.name}.tgz"
    }
  }
}

// Uses the S3 plugin to push the .tgz file to the ossimlabs
task dockerImageToS3(type: com.github.skhatri.s3aws.plugin.S3UploadTask, dependsOn: saveDockerImage) {
  bucket = 'o2-delivery/dev/docker'
  key = "${imageTgz}"
  file = "build/libs/${imageTgz}"
}

task removeArtifacts(dependsOn: dockerImageToS3) {
  doLast{
    exec {
      // Removes the image that is pushed to the remote repository
      // from the local Docker registry
      commandLine 'docker', 'rmi', "-f", "${dockerNamespaceUrl}${image}"
    }
    exec {
      // Removes the default image created during the build process from
      // from the local Docker registry
      commandLine 'docker', 'rmi', "-f", image
    }
    exec {
      // Removes the 'o2-base' image used during the build process
      commandLine 'docker', 'rmi', "-f", baseImage
    }
    exec {
      // Removes the zipped image that was pushed to S3
      commandLine 'rm', "build/libs/${imageTgz}"
    }
    exec {
      // Removes the base image zip file
      commandLine 'rm', "build/libs/${baseImageTgz}"
    }
  }
}

artifactory {
  contextUrl = "${artifactoryContextUrl}"   //The base Artifactory URL if not overridden by the publisher/resolver
  publish {
    repository {
      repoKey = "libs-${buildVersionTag.toLowerCase()}-local"
      username = "${artifactoryUser}"
      password = "${artifactoryPassword}"
      maven = true
    }
    defaults{
      publications("mavenJava")
    }
  }
  resolve {
    repository {
      repoKey = "libs-${buildVersionTag.toLowerCase()}"
      username = "${artifactoryUser}"
      password = "${artifactoryPassword}"
      maven = true
    }
  }
}
